<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>美食搜尋器</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/img/logo.png" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" type="text/css" />
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <!-- Vue.js-->
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
        <!-- axios.js-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- vue-axios.js-->
        <script src="https://cdn.jsdelivr.net/npm/vue-axios@3.2.5/dist/vue-axios.es5.min.js"></script>
        <!-- vue-star-rating.js-->
        <script src="https://unpkg.com/vue-star-rating/dist/VueStarRating.umd.min.js"></script>


</script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-light bg-light static-top">
            <div class="container">
                <a class="navbar-brand" href="#!">
                    <img src="assets/img/logo.png" width="30" height="24" class="d-inline-block align-text-top img-fluid" > 美食搜尋器</a>
            </div>
        </nav>
        <!-- Masthead-->
        <div id="app">
        <header class="masthead mb-4">
            <div class="container position-relative">
                <div class="row justify-content-center">
                    <div class="col-xl-6">
                        <div class="text-center text-white">

                            <h1 class="mb-5">你餓了嗎？<br>快使用美食搜尋器！</h1>

                            <form class="form-subscribe">

                                <div class="row">
                                    <div class="col">
                                        <input class="form-control form-control-lg" id="serachText" type="text" placeholder="今天想吃什麼？" v-model="keyword"/>
                                    </div>
                                    <div class="col-auto"><a class="btn btn-primary btn-lg" id="serach" @click="serach">搜尋</a></div>
                                </div>
                                <div class="col text-start mt-2">
                                    <a href="#" class="text-light mx-2" @click.prevent="serach">早午餐</a>
                                    <a href="#" class="text-light mx-2" @click.prevent="serach">下午茶</a>
                                    <a href="#" class="text-light mx-2" @click.prevent="serach">小吃店</a>
                                    <a href="#" class="text-light mx-2" @click.prevent="serach">宵夜</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Content-->
            <div class="container" id="content">
                <div class="row">
                    <div class="col-lg-3 mb-3" v-for="(item, key) in data.results" :key="item.id">
                        <div class="card">
                            <img :src="getPhtotPath(item)" class="card-img-top" style="max-height: 150px;">
                            <div class="card-body">
                              <h5 class="card-title">{{ item.name }}</h5>
                            </div>
                            <ul class="list-group list-group-flush">
                              <li class="list-group-item">{{ item.rating }} <star-rating v-model="item.rating" read-only="true" star-size="20" increment="0.01" :show-rating="false" :inline="true" class="ml-1"></star-rating>({{ item.user_ratings_total}})</li>
                              <li class="list-group-item" v-if="item.opening_hours">
                                <p v-if="item.opening_hours.open_now" class="text-success">營業中</p>
                                <p v-else class="text-danger">已打烊</p>
                              </li>
                              <li v-else class="list-group-item text-warning">未標示營業時間</li>
                              <li class="list-group-item">{{ item.vicinity }}</li>
                            </ul>
                            <div class="card-body">
                              <p>距離{{ distance(item.geometry.location.lat, item.geometry.location.lng, location.lat, location.lng) }}公里</p>
                            </div>
                          </div>
                    </div>
                </div>
                <nav aria-label="Page navigation" v-if="data">
                    <ul class="pagination">
                      <li class="page-item"><button class="btn btn-outline-primary mx-3" :class="{'disabled': pre_page}"  @click="previous">上一頁</button></li>
                      <li class="page-item"><button class="btn btn-outline-primary "  :class="{'disabled': nxt_page}" @click="next">下一頁</button></li>
                    </ul>
                  </nav>
            </div>
        </div>
        
        <!-- Footer-->
        <footer class="footer bg-light mt-4">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 h-100 text-center text-lg-start my-auto">
                        <p class="text-muted small mb-4 mb-lg-0">&copy; 美食搜尋器 2021. All Rights Reserved.</p>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>

<script>
let app = new Vue({
    el: '#app',
    data() {
        return {
            title: '美食搜尋器',
            // 若無法定位，則以沙鹿火車站為中心搜尋
            location: {
                lat: '24.2371582',
                lng: '120.5575871'
            },
            keyword: '',
            data: {},
            old_data: {},
            open: {},
            apiUrl: '',
            pre_tkn: '',
            nxt_tkn: '',
            pre_page: true,
            nxt_page: true
        }
    },
    methods: {
        getlocation(){
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(postion => {
                    this.location.lat = postion.coords.latitude
                    this.location.lng = postion.coords.longitude
                    console.log('成功獲取地理位置')
                });
            } else {
                console.log('當前無法取得地理座標,以沙鹿火車站作為基準')
            }
        },
        serach(e){
            this.isLoading = !this.isLoading
            let keyword;
            if(e.target.id === 'serach') keyword = this.keyword
            else                         keyword = e.target.innerText
            const api_key = 'AIzaSyAnb3NJwQ_b87NUiF02RvtUA_k_KylPjpM'
            const lat = this.location.lat
            const lng = this.location.lng
            const cors = 'https://cors.bridged.cc/'
            this.apiUrl = `${cors}https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${lat},${lng}&rankby=distance&types=food&keyword=${keyword}&language=zh-TW&key=${api_key}`
            this.axios.get(this.apiUrl,{
                headers: {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': '*',
                    'Access-Control-Allow-Headers': 'Origin, Methods, Content-Type, Authorization',
                    'Access-Control-Allow-Credentials': true,
                    'Origin': '*',
                    'x-requested-with':'XMLHttpRequest'
                }
            }).then((response) => {
                if(response.data.status === 'OK'){
                    console.log(response.data)
                    this.data = response.data
                    this.nxt_page = false
                    this.nxt_tkn = response.data.next_page_token
                }
                
            })
        },
        distance(lat1, lon1, lat2, lon2) {
            if ((lat1 == lat2) && (lon1 == lon2)) {
                return 0;
            }
            else {
                var radlat1 = Math.PI * lat1/180;
                var radlat2 = Math.PI * lat2/180;
                var theta = lon1-lon2;
                var radtheta = Math.PI * theta/180;
                var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
                if (dist > 1) {
                    dist = 1;
                }
                dist = Math.acos(dist);
                dist = dist * 180/Math.PI;
                dist = dist * 60 * 1.1515;
                dist = dist * 1.609344 
                return dist.toFixed(2);
            }
        },
        next(){
            tkn = this.nxt_tkn
            this.pre_page = false             
            const api = `${this.apiUrl}&pagetoken=${tkn}`
            this.axios.get(api).then((response) => {
                if(response.data.status === 'OK'){
                    console.log(response.data)
                    this.data = response.data
                    this.old_data = Object.assign({}, this.data)
                    this.nxt_tkn = response.data.next_page_token
                }
                
            })
        },
        previous(){
            console.log('123')
            this.data = {}
            this.data = Object.assign({}, this.old_data)
        }
    },
    computed: {
        getPhtotPath(){
            return function(item){
                if(item.photos){
                    const api_key = 'AIzaSyAnb3NJwQ_b87NUiF02RvtUA_k_KylPjpM'
                    const PHOTO_REFERENCE = item.photos[0].photo_reference
                    const MAX_HEIGHT = item.photos[0].height
                    const MAX_WIDTH = item.photos[0].width
                    return `https://maps.googleapis.com/maps/api/place/photo?photoreference=${PHOTO_REFERENCE}&sensor=false&maxheight=${MAX_HEIGHT}&maxwidth=${MAX_WIDTH}&key=${api_key}`
                }
            }
        }
    },
    created() {
        this.getlocation()
    },

})
Vue.component('star-rating', VueStarRating.default);
</script>